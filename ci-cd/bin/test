#!/bin/sh

set -eu

auth_url_enc_file = ${1:-sfdx_auth_url.txt.enc}
scratch_org_def_file = ${2:-config/project-scratch-def.json}

# Decrypt Auth URL File
openssl enc -d -aes-256-cbc -in $auth_url_enc_file -out auth_url.txt -k $AUTH_FILE_KEY

# Authenticate DevHub Org
sfdx force:auth:sfdxurl:store -f auth_url.txt -d -a DevHub && rm auth_url.txt

# Spin up new scratch org
sfdx force:org:create -v DevHub -s -f $scratch_org_def_file

# Push Source
sfdx force:source:push

# Run Test(s)
sfdx force:apex:test:run -c -r human

# Mark Org for Deletion
sfdx force:org:delete -p